{% extends "base.html" %}
{% block content %}
<style>
    /* Styling */
    .top-section { display: flex; gap: 24px; margin-bottom: 24px; }
    .panel { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; overflow: hidden; }
    .panel-header { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
    .table-modern { width: 100%; border-collapse: collapse; }
    .table-modern th { text-align: left; padding: 10px 16px; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; border-bottom: 1px solid #e5e7eb; background: #fff; }
    .table-modern td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; cursor: pointer; vertical-align: middle; }
    .table-modern tr:hover { background-color: #f9fafb; }
    .row-active { background-color: #eff6ff !important; border-left: 3px solid #4f46e5; }
    .prio-High { border-left: 4px solid #ef4444 !important; }
    .prio-Medium { border-left: 4px solid #f59e0b !important; }
    .prio-Low { border-left: 4px solid #10b981 !important; }
    .btn-icon { border:none; background:none; padding: 4px; color:#9ca3af; transition: color 0.2s; }
    .btn-icon:hover { color: #4f46e5; }
    .btn-icon-danger:hover { color: #ef4444; }
    .group-list-item { cursor: pointer; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; transition: background 0.2s; }
    .group-list-item:hover { background: #f3f4f6; }
    .group-list-item.active { background: #eef2ff; color: #4f46e5; font-weight: 600; }
</style>

<div class="top-section">
    <div class="panel" style="flex: 0 0 320px;">
        <div class="panel-header"><h6>Clients</h6><button class="btn btn-sm btn-primary" onclick="openModal('client-modal')">+</button></div>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="table-modern">
                {% for client in clients %}
                <tr class="client-row" onclick="loadProjects({{ client.id }}, this)">
                    <td>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-medium">{{ client.company_name }}</span>
                            <div onclick="event.stopPropagation()">
                                <button class="btn-icon" onclick="editClient({{ client.id }})"><i class="bi bi-pencil"></i></button>
                                <button class="btn-icon btn-icon-danger" onclick="deleteClient({{ client.id }})"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    <div class="panel" style="flex: 1;">
        <div class="panel-header"><h6>Projects</h6><button id="add-project-btn" class="btn btn-sm btn-primary d-none" onclick="openProjectModal()">+ Project</button></div>
        <div id="project-list-area" class="p-0">
            <div class="p-4 text-center text-muted">Select a client to view projects.</div>
        </div>
    </div>
</div>

<div class="panel d-none" id="task-panel">
    <div class="panel-header"><h6>Tasks: <span id="active-project-name"></span></h6><div class="d-flex gap-2"><a href="#" id="gantt-link" target="_blank" class="btn btn-sm btn-outline-secondary">Gantt</a><button class="btn btn-sm btn-primary" onclick="openAddTaskModal()">+ New Task</button></div></div>
    <div id="task-list-area"></div>
</div>

<div class="modal fade" id="user-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content p-4">
    <h5>User Management</h5>
    <div class="list-group mb-3" id="admin-user-list"></div>
    <form id="add-user-form">
        <input type="text" name="first_name" class="form-control mb-2" placeholder="First Name">
        <input type="email" name="email" class="form-control mb-2" placeholder="Email/Username" required>
        <input type="password" name="password" class="form-control mb-2" placeholder="Password" required>
        <button type="submit" class="btn btn-primary w-100">Add User</button>
    </form>
</div></div></div>

<div class="modal fade" id="group-management-modal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Group Management</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="resetGroupForm()">+ New Group</button>
    </div>
    <div class="row">
        <div class="col-md-4 border-end">
            <h6 class="text-muted small fw-bold">Groups</h6>
            <div id="admin-group-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
        <div class="col-md-8">
            <form id="group-management-form">
                <input type="hidden" name="id" id="gm_id">
                <label class="small fw-bold">Group Name</label>
                <input type="text" name="name" id="gm_name" class="form-control mb-3" placeholder="e.g. Development" required>
                <label class="small fw-bold">Assigned Users</label>
                <div id="gm_users_container" class="border p-2 mb-3 rounded" style="max-height:200px; overflow-y:auto; background:#f9fafb;"></div>
                <button type="submit" class="btn btn-primary w-100">Save Group Changes</button>
            </form>
        </div>
    </div>
</div></div></div>

<div class="modal fade" id="client-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content p-4">
    <h5>Client Details</h5>
    <form id="client-form">
        <input type="hidden" name="id" id="c_id">
        <input type="text" name="company_name" id="c_name" class="form-control mb-2" placeholder="Company Name" required>
        <input type="text" name="contact_name" id="c_contact" class="form-control mb-2" placeholder="Contact">
        <input type="text" name="location" id="c_loc" class="form-control mb-2" placeholder="Location">
        <input type="text" name="phone_number" id="c_phone" class="form-control mb-2" placeholder="Phone">
        <input type="email" name="main_contact_email" id="c_email" class="form-control mb-3" placeholder="Email">
        <button type="submit" class="btn btn-primary w-100">Save Client</button>
    </form>
</div></div></div>

<div class="modal fade" id="project-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content p-4">
    <h5>Project Details</h5>
    <form id="project-form">
        <input type="hidden" name="id" id="p_id"><input type="hidden" name="client_id" id="p_cid">
        <input type="text" name="name" id="p_name" class="form-control mb-2" placeholder="Project Name" required>
        <input type="date" name="proposed_start_date" id="p_date" class="form-control mb-3">
        <button type="submit" class="btn btn-primary w-100">Save Project</button>
    </form>
</div></div></div>

<div class="modal fade" id="task-modal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content p-4">
    <h5>Task Details</h5>
    <div id="date-warning" class="alert alert-warning small d-none"><i class="bi bi-exclamation-triangle"></i> Start date updated to match predecessor.</div>
    <form id="task-form">
        <input type="hidden" name="task_id" id="t_id"><input type="hidden" name="project_id" id="t_pid">
        <div class="row">
            <div class="col-md-6">
                <input type="text" name="task_name" id="t_name" class="form-control mb-2" placeholder="Task Name" required>
                <div class="row g-2 mb-2">
                    <div class="col"><select name="priority" id="t_priority" class="form-select"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select></div>
                    <div class="col"><select name="dependency_id" id="t_dependency" class="form-select" onchange="validateDate()"><option value="">Predecessor: None</option></select></div>
                </div>
                <div class="row g-2 mb-2"><div class="col"><input type="date" name="start_date" id="t_date" class="form-control" required onchange="validateDate()"></div><div class="col"><input type="number" name="duration_days" id="t_dur" class="form-control" value="1"></div></div>
                <textarea name="comments" id="t_comments" class="form-control" rows="3" placeholder="Notes..."></textarea>
            </div>
            <div class="col-md-6">
                <label class="small fw-bold">1. Select Groups</label>
                <div id="modal_groups" class="border rounded p-2 mb-3" style="max-height:120px; overflow-y:auto;"></div>
                <label class="small fw-bold">2. Assign Users</label>
                <div id="modal_users" class="border rounded p-2" style="max-height:150px; overflow-y:auto;"></div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-3">Save Task</button>
    </form>
</div></div></div>

<script>
    let currentTasks = [], allGroups = [], allUsers = [];
    let activeClientId = null, activeProjectId = null;
    let currentlySelectedUsers = [];

    document.addEventListener('DOMContentLoaded', () => { refreshMetadata(); });

    function refreshMetadata() {
        fetch('/api/groups').then(r=>r.json()).then(d=> { allGroups=d; renderAdminGroupList(); });
        fetch('/api/users').then(r=>r.json()).then(d=> { allUsers=d; const adminU = document.getElementById('admin-user-list'); if(adminU) { adminU.innerHTML = ''; d.forEach(u => { adminU.innerHTML += `<div class="list-group-item d-flex justify-content-between">${u.display_name} <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id})">x</button></div>`; }); } });
    }

    // --- DATE VALIDATION ---
    function validateDate() {
        const depId = document.getElementById('t_dependency').value;
        const dateInput = document.getElementById('t_date');
        const warning = document.getElementById('date-warning');

        if (!depId) { warning.classList.add('d-none'); return; }

        const parentTask = currentTasks.find(t => t.id == depId);
        if (parentTask) {
            const parentStart = new Date(parentTask.start_date);
            // Add duration to get end date
            const parentEnd = new Date(parentStart);
            parentEnd.setDate(parentStart.getDate() + parentTask.duration_days);

            const currentStart = new Date(dateInput.value);

            if (currentStart < parentEnd) {
                // If user selected date is too early, warn and correct it
                warning.classList.remove('d-none');
                dateInput.value = parentEnd.toISOString().split('T')[0];
            } else {
                warning.classList.add('d-none');
            }
        }
    }

    // --- PROJECT LOADER ---
    function loadProjects(cid, row) {
        activeClientId = cid;
        if(row) { document.querySelectorAll('.client-row').forEach(r => r.classList.remove('row-active')); row.classList.add('row-active'); }
        document.getElementById('add-project-btn').classList.remove('d-none');

        fetch(`/api/projects/${cid}`).then(r=>r.json()).then(data => {
            const container = document.getElementById('project-list-area');
            let html = `<table class="table-modern w-100"><thead><tr><th style="width:40%">Project</th><th style="width:40%">Progress</th><th style="width:20%" class="text-end">Actions</th></tr></thead><tbody>`;

            if(data.length === 0) { html = '<div class="p-4 text-center text-muted">No projects found.</div>'; } else {
                data.forEach(p => {
                    const barColor = p.completion_percent === 100 ? 'bg-success' : 'bg-primary';
                    html += `<tr onclick="loadTasks(${p.id}, '${p.name.replace(/'/g, "\\'")}')">
                        <td><div class="fw-bold text-dark">${p.name}</div><small class="text-muted" style="font-size:0.75rem">${p.proposed_start_date || ''}</small></td>
                        <td class="align-middle" style="padding:0 15px;"><div class="d-flex align-items-center"><div class="progress flex-grow-1" style="height: 6px;"><div class="progress-bar ${barColor}" style="width: ${p.completion_percent}%"></div></div><span class="ms-2 small text-muted">${p.completion_percent}%</span></div></td>
                        <td class="text-end align-middle"><div onclick="event.stopPropagation()"><button class="btn-icon" onclick="editProject(${p.id})"><i class="bi bi-pencil"></i></button><button class="btn-icon btn-icon-danger" onclick="deleteProject(${p.id})"><i class="bi bi-trash"></i></button></div></td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }
            container.innerHTML = html;
        });
    }

    function loadTasks(pid, name) {
        activeProjectId = pid;
        document.getElementById('active-project-name').innerText = name;
        document.getElementById('task-panel').classList.remove('d-none');
        document.getElementById('gantt-link').href = `/gantt/project/${pid}`;
        fetch(`/api/projects/${activeClientId}`).then(r=>r.json()).then(data => {
            currentTasks = data.find(p => p.id === pid).tasks;
            renderTaskTable();
        });
    }

    function renderTaskTable() {
        let html = '<table class="table-modern"><thead><tr><th style="width:40px"></th><th>Task</th><th class="text-end">Actions</th></tr></thead><tbody>';
        currentTasks.forEach(t => {
            html += `<tr class="prio-${t.priority}"><td><input type="checkbox" ${t.is_completed ? 'checked' : ''} onclick="toggleTask(${t.id})"></td><td onclick="openEditTaskModal(${t.id})"><div class="fw-bold">${t.name}</div><small class="text-muted">${t.assignee_names || 'Unassigned'} | ${t.duration_days} Days</small></td><td class="text-end"><button class="btn btn-sm text-danger" onclick="deleteTask(${t.id})">x</button></td></tr>`;
        });
        document.getElementById('task-list-area').innerHTML = html + '</tbody></table>';
    }

    // --- PICKERS ---
    function renderAdminGroupList() {
        const list = document.getElementById('admin-group-list'); if(!list) return; list.innerHTML = '';
        allGroups.forEach(g => { list.innerHTML += `<div class="group-list-item d-flex justify-content-between align-items-center" onclick="editGroup(${g.id})"><span>${g.name}</span><button class="btn-icon btn-icon-danger" onclick="event.stopPropagation(); deleteGroup(${g.id})"><i class="bi bi-trash"></i></button></div>`; });
    }
    function renderGroupUserPicker(selectedUserIds=[]) {
        const c = document.getElementById('gm_users_container'); c.innerHTML = '';
        allUsers.forEach(u => { const isChecked = selectedUserIds.includes(u.id) ? 'checked' : ''; c.innerHTML += `<div><input type="checkbox" class="form-check-input me-2 gm-user-chk" value="${u.id}" ${isChecked}> ${u.display_name}</div>`; });
    }
    function editGroup(id) { document.querySelectorAll('.group-list-item').forEach(el => el.classList.remove('active')); fetch(`/api/group/${id}`).then(r=>r.json()).then(d => { document.getElementById('gm_id').value = d.id; document.getElementById('gm_name').value = d.name; renderGroupUserPicker(d.member_ids); }); }
    function resetGroupForm() { document.getElementById('group-management-form').reset(); document.getElementById('gm_id').value = ''; renderGroupUserPicker([]); document.querySelectorAll('.group-list-item').forEach(el => el.classList.remove('active')); }

    function renderUserGroupPickers(selG=[], selU=[]) { currentlySelectedUsers = selU; const gc = document.getElementById('modal_groups'); gc.innerHTML = ''; allGroups.forEach(g => { const isChecked = selG.includes(g.id) ? 'checked' : ''; gc.innerHTML += `<div><input type="checkbox" name="group_ids" value="${g.id}" ${isChecked} onchange="updateUserPicker()"> ${g.name}</div>`; }); updateUserPicker(); }
    function updateUserPicker() { const selectedGroupIds = Array.from(document.querySelectorAll('input[name="group_ids"]:checked')).map(cb => parseInt(cb.value)); const uc = document.getElementById('modal_users'); uc.innerHTML = ''; if(selectedGroupIds.length === 0) { uc.innerHTML = '<small class="text-muted">Select a group...</small>'; return; } const filteredUsers = allUsers.filter(u => u.group_ids.some(gid => selectedGroupIds.includes(gid))); filteredUsers.forEach(u => { const isChecked = currentlySelectedUsers.includes(u.id) ? 'checked' : ''; uc.innerHTML += `<div><input type="checkbox" name="user_ids" value="${u.id}" ${isChecked}> ${u.display_name}</div>`; }); }

    // --- MODALS ---
    function openAddTaskModal() { document.getElementById('task-form').reset(); document.getElementById('t_pid').value = activeProjectId; document.getElementById('t_id').value = ''; renderUserGroupPickers([], []); const drop = document.getElementById('t_dependency'); drop.innerHTML = '<option value="">None</option>'; currentTasks.forEach(t => drop.innerHTML += `<option value="${t.id}">${t.name}</option>`); document.getElementById('date-warning').classList.add('d-none'); openModal('task-modal'); }
    function openEditTaskModal(tid) { const t = currentTasks.find(x => x.id === tid); document.getElementById('t_id').value = t.id; document.getElementById('t_pid').value = t.project_id; document.getElementById('t_name').value = t.name; document.getElementById('t_priority').value = t.priority; document.getElementById('t_date').value = t.start_date; document.getElementById('t_dur').value = t.duration_days; document.getElementById('t_comments').value = t.comments; const drop = document.getElementById('t_dependency'); drop.innerHTML = '<option value="">None</option>'; currentTasks.forEach(tk => { if(tk.id != tid) drop.innerHTML += `<option value="${tk.id}">${tk.name}</option>`; }); document.getElementById('t_dependency').value = t.dependency_id || ''; renderUserGroupPickers(t.group_ids, t.assignee_ids); document.getElementById('date-warning').classList.add('d-none'); openModal('task-modal'); }
    function openProjectModal() { document.getElementById('project-form').reset(); document.getElementById('p_cid').value = activeClientId; document.getElementById('p_id').value = ''; openModal('project-modal'); }
    function editClient(id) { fetch(`/api/client/${id}`).then(r=>r.json()).then(d => { document.getElementById('c_id').value=d.id; document.getElementById('c_name').value=d.company_name; document.getElementById('c_contact').value=d.contact_name; document.getElementById('c_loc').value=d.location; document.getElementById('c_phone').value=d.phone_number; document.getElementById('c_email').value=d.main_contact_email; openModal('client-modal'); }); }
    function editProject(id) { fetch(`/api/project/${id}`).then(r=>r.json()).then(d => { document.getElementById('p_id').value=d.id; document.getElementById('p_cid').value=d.client_id; document.getElementById('p_name').value=d.name; document.getElementById('p_date').value=d.proposed_start_date; openModal('project-modal'); }); }

    // --- SUBMITS ---
    document.getElementById('client-form').onsubmit = (e) => { e.preventDefault(); fetch('/api/client/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(Object.fromEntries(new FormData(e.target)))}).then(() => location.reload()); };
    document.getElementById('project-form').onsubmit = (e) => { e.preventDefault(); fetch('/api/project/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(Object.fromEntries(new FormData(e.target)))}).then(() => { loadProjects(activeClientId); bootstrap.Modal.getInstance(document.getElementById('project-modal')).hide(); }); };
    document.getElementById('task-form').onsubmit = (e) => { e.preventDefault(); const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries()); data.group_ids = fd.getAll('group_ids'); data.user_ids = fd.getAll('user_ids'); fetch(data.task_id ? '/api/task/update' : '/api/task/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}).then(() => { loadTasks(activeProjectId, document.getElementById('active-project-name').innerText); bootstrap.Modal.getInstance(document.getElementById('task-modal')).hide(); }); };
    if(document.getElementById('group-management-form')) { document.getElementById('group-management-form').onsubmit = (e) => { e.preventDefault(); const data = { id: document.getElementById('gm_id').value, name: document.getElementById('gm_name').value }; data.user_ids = Array.from(document.querySelectorAll('.gm-user-chk:checked')).map(c => parseInt(c.value)); fetch('/api/group/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}).then(() => { refreshMetadata(); resetGroupForm(); }); }; }
    if(document.getElementById('add-user-form')) { document.getElementById('add-user-form').onsubmit = (e) => { e.preventDefault(); fetch('/api/user/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(Object.fromEntries(new FormData(e.target)))}).then(() => { refreshMetadata(); e.target.reset(); }); }; }

    function deleteClient(id) { fetch('/api/client/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})}).then(()=>location.reload()); }
    function deleteProject(id) { fetch('/api/project/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})}).then(()=>loadProjects(activeClientId)); }
    function deleteUser(uid) { fetch('/api/user/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid})}).then(()=>refreshMetadata()); }
    function deleteGroup(gid) { fetch('/api/group/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:gid})}).then(()=>refreshMetadata()); }
    function toggleTask(id) { fetch('/api/task/complete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({task_id:id})}).then(() => loadTasks(activeProjectId, document.getElementById('active-project-name').innerText)); }
    function deleteTask(id) { fetch('/api/task/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({task_id:id})}).then(() => loadTasks(activeProjectId, document.getElementById('active-project-name').innerText)); }
</script>
{% endblock %}