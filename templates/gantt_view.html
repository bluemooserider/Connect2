{% extends "base.html" %}

{% block content %}
<div class="panel p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="fw-bold mb-0">Project Timeline</h3>
            <p class="text-muted small">Project: {{ project.name }}</p>
        </div>
        <div>
            <a href="/" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
        </div>
    </div>

    <div id="chart_div" style="width: 100%; min-height: 600px;"></div>
</div>

<div class="modal fade" id="task-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-light">
                <h6 class="modal-title fw-bold">Edit Task</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <input type="hidden" name="task_id" id="t_id">
                    <input type="hidden" name="project_id" id="t_pid" value="{{ project.id }}">

                    <div class="row">
                        <div class="col-md-6">
                            <label class="small fw-bold">Task Name</label>
                            <input type="text" name="task_name" id="t_name" class="form-control mb-2" required>

                            <div class="row g-2 mb-2">
                                <div class="col">
                                    <label class="small fw-bold">Priority</label>
                                    <select name="priority" id="t_priority" class="form-select">
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="small fw-bold">Predecessor</label>
                                    <select name="dependency_id" id="t_dependency" class="form-select">
                                        <option value="">None</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-2 mb-2">
                                <div class="col"><label class="small fw-bold">Start</label><input type="date" name="start_date" id="t_date" class="form-control" required></div>
                                <div class="col"><label class="small fw-bold">Duration</label><input type="number" name="duration_days" id="t_dur" class="form-control"></div>
                            </div>
                            <textarea name="comments" id="t_comments" class="form-control" rows="3" placeholder="Notes..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">1. Select Groups</label>
                            <div id="modal_groups" class="border rounded p-2 mb-3" style="max-height:120px; overflow-y:auto;"></div>
                            <label class="small fw-bold">2. Assign Users</label>
                            <div id="modal_users" class="border rounded p-2" style="max-height:150px; overflow-y:auto;"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-light text-danger" onclick="deleteTask()">Delete</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    let allGroups = [], allUsers = [];
    let currentTasks = []; // To populate predecessor dropdown
    const projectId = {{ project.id }};

    document.addEventListener('DOMContentLoaded', () => {
        // Fetch metadata for modal
        fetch('/api/groups').then(r=>r.json()).then(d=>allGroups=d);
        fetch('/api/users').then(r=>r.json()).then(d=>allUsers=d);

        // Fetch tasks for dropdown population
        fetch(`/api/projects/{{ project.client_id }}`).then(r=>r.json()).then(data => {
            const p = data.find(x => x.id === projectId);
            if(p) currentTasks = p.tasks;
        });
    });

    google.charts.load('current', {'packages':['gantt']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        fetch('{{ url_for("api_gantt_data", source_type="project", source_id=project.id) }}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('chart_div');
            if (!data.tasks || data.tasks.length === 0) {
                container.innerHTML = '<div class="alert alert-info text-center mt-5">No tasks found. Add tasks from the dashboard to see the timeline.</div>';
                return;
            }

            var dt = new google.visualization.DataTable();
            dt.addColumn('string', 'Task ID');
            dt.addColumn('string', 'Task Name');
            dt.addColumn('string', 'Resource');
            dt.addColumn('date', 'Start Date');
            dt.addColumn('date', 'End Date');
            dt.addColumn('number', 'Duration');
            dt.addColumn('number', 'Percent Complete');
            dt.addColumn('string', 'Dependencies');

            const rows = data.tasks.map(t => [
                t[0], t[1], t[2],
                new Date(t[3]), new Date(t[4]),
                t[5], t[6], t[7]
            ]);

            dt.addRows(rows);

            var options = {
                height: rows.length * 42 + 50,
                gantt: {
                    trackHeight: 30,
                    palette: [
                        { "color": "#4f46e5", "dark": "#3730a3", "light": "#c7d2fe" },
                        { "color": "#f59e0b", "dark": "#b45309", "light": "#fcd34d" }
                    ]
                }
            };

            var chart = new google.visualization.Gantt(container);

            // INTERACTIVITY: Click event
            google.visualization.events.addListener(chart, 'select', function() {
                var selection = chart.getSelection();
                if (selection.length > 0) {
                    var row = selection[0].row;
                    var taskId = dt.getValue(row, 0); // Col 0 is Task ID
                    openEditTaskModal(taskId);
                }
            });

            chart.draw(dt, options);
        });
    }

    // --- MODAL LOGIC (Copied & Adapted from Index) ---
    function openEditTaskModal(tid) {
        // Fetch full task details because Gantt data is simplified
        fetch(`/api/task/${tid}`).then(r => r.json()).then(t => {
            if(t.success === false) return;

            document.getElementById('t_id').value = t.id;
            document.getElementById('t_name').value = t.name;
            document.getElementById('t_priority').value = t.priority;
            document.getElementById('t_date').value = t.start_date.split('T')[0];
            document.getElementById('t_dur').value = t.duration_days;
            document.getElementById('t_comments').value = t.comments || '';

            // Populate Predecessors (exclude self)
            const drop = document.getElementById('t_dependency');
            drop.innerHTML = '<option value="">None</option>';
            currentTasks.forEach(tk => {
                if(tk.id != t.id) drop.innerHTML += `<option value="${tk.id}">${tk.name}</option>`;
            });
            document.getElementById('t_dependency').value = t.dependency_id || '';

            renderUserGroupPickers(t.group_ids, t.assignee_ids);
            new bootstrap.Modal(document.getElementById('task-modal')).show();
        });
    }

    function renderUserGroupPickers(selG=[], selU=[]) {
        const gc = document.getElementById('modal_groups'); gc.innerHTML = '';
        allGroups.forEach(g => {
            const isChecked = selG.includes(g.id) ? 'checked' : '';
            gc.innerHTML += `<div><input type="checkbox" name="group_ids" value="${g.id}" ${isChecked} onchange="updateUserPicker()"> ${g.name}</div>`;
        });
        updateUserPicker(selU);
    }

    function updateUserPicker(selU=[]) {
        // Simple version: Show all users if groups checked, or allow free selection
        // For consistency with Dashboard, let's filter by group
        const selectedG = Array.from(document.querySelectorAll('input[name="group_ids"]:checked')).map(cb => parseInt(cb.value));
        const uc = document.getElementById('modal_users'); uc.innerHTML = '';

        if(selectedG.length === 0) { uc.innerHTML = '<small class="text-muted">Select a group...</small>'; return; }

        const filtered = allUsers.filter(u => u.group_ids.some(gid => selectedG.includes(gid)));
        filtered.forEach(u => {
            const isChecked = selU && selU.includes(u.id) ? 'checked' : '';
            uc.innerHTML += `<div><input type="checkbox" name="user_ids" value="${u.id}" ${isChecked}> ${u.display_name}</div>`;
        });
    }

    document.getElementById('task-form').onsubmit = (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        data.group_ids = fd.getAll('group_ids');
        data.user_ids = fd.getAll('user_ids');

        fetch('/api/task/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(() => location.reload()); // Reload to redraw chart
    };

    function deleteTask() {
        const tid = document.getElementById('t_id').value;
        if(confirm("Delete this task?")) {
            fetch('/api/task/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task_id: tid})
            }).then(() => location.reload());
        }
    }
</script>
{% endblock %}